<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card shadow-sm border-0 login-container">
        <div class="card-body p-4">
         
          <div class="text-center mb-4">
            <img src="assets/logo.jpg" alt="EduLearn Logo" class="login-logo">
          </div>

          <div *ngIf="currentStep === 1" class="step-content">
            <h3 class="text-center text-primary mb-3">Mot de passe oublié</h3>
            <p class="text-center text-muted mb-4">
              Entrez votre adresse email pour recevoir un code de vérification
            </p>

            <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="fas fa-exclamation-circle me-2"></i>
              {{ errorMessage }}
              <button type="button" class="btn-close" (click)="clearError()"></button>
            </div>

            <form (ngSubmit)="sendVerificationCode()">
              <div class="mb-4">
                <label for="email" class="form-label fw-bold">Adresse email</label>
                <input
                  type="email"
                  id="email"
                  class="form-control"
                  placeholder="nom@exemple.com"
                  [(ngModel)]="email"
                  name="email"
                  required
                />
              </div>

              <div class="d-grid mb-3">
                <button type="submit" class="btn btn-primary btn-lg" [disabled]="isLoading">
                  <span *ngIf="!isLoading">Envoyer le code</span>
                  <span *ngIf="isLoading">
                    <i class="fas fa-spinner fa-spin me-2"></i>Envoi...
                  </span>
                </button>
              </div>
            </form>

            <div class="text-center">
              <a routerLink="/connexion" class="text-decoration-none">
                <i class="fas fa-arrow-left me-2"></i>Retour à la connexion
              </a>
            </div>
          </div>

          <!-- Étape 2: Vérification du code -->
          <div *ngIf="currentStep === 2" class="step-content">
            <h3 class="text-center text-primary mb-3">Vérification du code</h3>
            
            <!-- Compte à rebours -->
            <div class="text-center mb-4">
              <div class="countdown-timer">
                <i class="fas fa-clock me-2"></i>
                Code valide pendant: 
                <span class="countdown-text">{{ countdownMinutes }}:{{ countdownSeconds | number:'2.0' }}</span>
              </div>
            </div>

            <p class="text-center text-muted mb-4">
              Un code à 6 chiffres a été envoyé à 
              <strong>{{ maskedEmail }}</strong>
            </p>

            <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="fas fa-exclamation-circle me-2"></i>
              {{ errorMessage }}
              <button type="button" class="btn-close" (click)="clearError()"></button>
            </div>

            <form (ngSubmit)="verifyCode()">
              <div class="mb-4">
                <label class="form-label fw-bold">Code de vérification</label>
                <div class="verification-inputs">
                  <input *ngFor="let i of [0,1,2,3,4,5]; let idx = index"
                    type="text"
                    maxlength="1"
                    class="code-input"
                    [class.is-invalid]="codeError"
                    [(ngModel)]="verificationCode[idx]"
                    [name]="'code' + idx"
                    (input)="onCodeInput($event, idx)"
                    (keydown)="onCodeKeyDown($event, idx)"
                  />
                </div>
                <div *ngIf="codeError" class="invalid-feedback d-block">
                  Code incorrect
                </div>
              </div>

              <div class="d-grid mb-3">
                <button type="submit" class="btn btn-primary btn-lg" [disabled]="isLoading">
                  <span *ngIf="!isLoading">Vérifier le code</span>
                  <span *ngIf="isLoading">
                    <i class="fas fa-spinner fa-spin me-2"></i>Vérification...
                  </span>
                </button>
              </div>
            </form>

            <div class="text-center">
              <a href="#" (click)="resendCode($event)" class="text-decoration-none me-3">
                <i class="fas fa-redo me-1"></i>Renvoyer le code
              </a>
              <a href="#" (click)="changeEmail($event)" class="text-decoration-none">
                <i class="fas fa-edit me-1"></i>Changer l'email
              </a>
            </div>
          </div>

          <!-- Étape 3: Nouveau mot de passe -->
          <div *ngIf="currentStep === 3" class="step-content">
            <h3 class="text-center text-primary mb-3">Nouveau mot de passe</h3>
            <p class="text-center text-muted mb-4">
              Créez votre nouveau mot de passe
            </p>

            <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="fas fa-exclamation-circle me-2"></i>
              {{ errorMessage }}
              <button type="button" class="btn-close" (click)="clearError()"></button>
            </div>

            <form (ngSubmit)="resetPassword()">
              <div class="mb-3">
                <label for="newPassword" class="form-label fw-bold">Nouveau mot de passe</label>
                <input
                  type="password"
                  id="newPassword"
                  class="form-control"
                  placeholder="••••••••"
                  [(ngModel)]="newPassword"
                  name="newPassword"
                  required
                  minlength="8"
                />
                <div class="form-text">Le mot de passe doit contenir au moins 8 caractères</div>
              </div>

              <div class="mb-4">
                <label for="confirmPassword" class="form-label fw-bold">Confirmer le mot de passe</label>
                <input
                  type="password"
                  id="confirmPassword"
                  class="form-control"
                  placeholder="••••••••"
                  [(ngModel)]="confirmPassword"
                  name="confirmPassword"
                  required
                />
                <div *ngIf="confirmPassword && newPassword !== confirmPassword" 
                     class="text-danger small mt-1">
                  Les mots de passe ne correspondent pas
                </div>
              </div>

              <div class="d-grid mb-3">
                <button type="submit" 
                        class="btn btn-primary btn-lg" 
                        [disabled]="isLoading || !newPassword || !confirmPassword || newPassword !== confirmPassword">
                  <span *ngIf="!isLoading">Réinitialiser le mot de passe</span>
                  <span *ngIf="isLoading">
                    <i class="fas fa-spinner fa-spin me-2"></i>Réinitialisation...
                  </span>
                </button>
              </div>
            </form>
          </div>

          <!-- Étape 4: Confirmation -->
          <div *ngIf="currentStep === 4" class="step-content text-center">
            <div class="success-icon mb-3">
              <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="text-primary mb-3">Mot de passe réinitialisé !</h3>
            <p class="text-muted mb-4">
              Votre mot de passe a été réinitialisé avec succès.
            </p>
            
            <div class="d-grid">
              <a routerLink="/connexion" class="btn btn-primary btn-lg">
                Se connecter
              </a>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>